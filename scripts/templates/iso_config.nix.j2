{ lib, pkgs, ... }:
 {
  imports = [ ../../modules ];

  hostname = "{{hostname}}";
  gateway = "{{host.gateway}}";
  interface= "{{host.interface}}";
  ip = "{{host.ip}}";
  netmask = {{host.netmask}};
  subnet = "{{host.subnet}}";
  admin = {
    hashedPwd = ''{{host.admin.hashedPwd}}'';
    name = "{{host.admin.name}}";
    sshKeys = [
      {%- for key in host.admin.sshKeys %}
        ''{{key}}''
      {% endfor -%}
      ];
  };
  


  # copy all configuration files
  environment.etc = {
    # "nixos/generated" = { source = lib.sources.sourceFilesBySuffices ../generated [".nix"]; };
    "nixos/modules" = { source = ../../modules; };
    "nixos/configuration.nix" = {
      text = ''
        { config, ... }:{
          imports = [ ./modules ./hardware-configuration.nix];

          hostname = "{{hostname}}";
          gateway = "{{host.gateway}}";
          interface= "{{host.interface}}";
          ip = "{{host.ip}}";
          netmask = {{host.netmask}};
          subnet = "{{host.subnet}}";
          admin = {
            hashedPwd = '''{{host.admin.hashedPwd}}''';
            name = "{{host.admin.name}}";
            sshKeys = [
              {%- for key in host.admin.sshKeys %}
                '''{{key}}'''
              {% endfor -%}
              ];
          };
          services.openssh.enable = true;
          networking.firewall.allowedTCPPorts = config.services.openssh.ports;
          {% if not legacy -%}
          boot.loader.systemd-boot.enable = true;
          boot.loader.efi.canTouchEfiVariables = true;
          fileSystems."/boot".device = "/dev/disk/by-label/boot";
          fileSystems."/".device = "/dev/disk/by-label/nixos";
          {%- else %}
          boot.loader.grub.device = "/dev/vda"; # FIXME: /dev/vda is too specific
          fileSystems."/".device = "/dev/disk/by-label/nixos";
          {%- endif %}
         }
      '';
    };
  };
  environment.systemPackages = 
  let 
    # wrap install scripts in a package
    setup = pkgs.writeScriptBin "setup" ''
      {{setup_script|indent(6)|replace("${","''${")}}
    '';
    partition =  pkgs.writeScriptBin "partition" ''
      {{partition_script|indent(6)|replace("${","''${")}}
    ''; in with pkgs; 
  [
    dig
    setup
    partition
    bash
    parted
  ];

  {% if autoinstall -%}
  # Systemd script for automatic setup
  # Logs for debug: journalctl -u system_setup.service -b
  systemd.services.system_setup = {
    path = with pkgs; [
      bash
      coreutils
      dig
      e2fsprogs
      git
      mount
      nix
      nixos-install-tools
      parted
      partition
      setup
      sudo
      umount
      util-linux
    ];
    after = ["network-online.target"];
    wants = ["network-online.target"];
    wantedBy = [ "multi-user.target" ];
    requires = [ "network-online.target" "nss-lookup.target" "nix-deamon.service" ];
    serviceConfig = {
      Type = "oneshot";
      RemainAfterExit = "yes";
    };
    script = ''
      setup
      systemctl --force poweroff
    '';
  };
  {%- endif %}
}
